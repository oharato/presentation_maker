# Cloudflare Workers 設定ファイル (API)

name = "presentation-maker-api"
main = "index.ts" 
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

# マイグレーション設定（グローバル）
[[migrations]]
tag = "v1"
new_classes = ["JobManager"]

# 開発環境 (wrangler dev)
[env.development]
name = "presentation-maker-api-dev"
vars = { ENVIRONMENT = "development", MOCK_QUEUE = "true", CONTAINER_API_URL = "http://video-worker:80", CONTAINER_API_TOKEN = "dev-token", R2_ENDPOINT = "http://minio:9000", R2_ACCESS_KEY_ID = "minioadmin", R2_SECRET_ACCESS_KEY = "minioadmin", R2_BUCKET_NAME = "presentation-videos", R2_PUBLIC_URL = "http://minio:9000/presentation-videos" }
[[env.development.r2_buckets]]
binding = "PRESENTATION_MAKER_BUCKET"
bucket_name = "presentation-videos"
preview_bucket_name = "presentation-videos-preview"
[[env.development.kv_namespaces]]
binding = "PRESENTATION_MAKER_CACHE"
id = "2f2a03c8da9f471c867383b2dbb1ceca"
preview_id = "8293d34911c4414087b31fba4ac84929"
[[env.development.durable_objects.bindings]]
name = "PRESENTATION_MAKER_JOB_MANAGER"
class_name = "JobManager"

# ステージング環境
[env.staging]
name = "presentation-maker-api-staging"
vars = { ENVIRONMENT = "staging" }
[[env.staging.r2_buckets]]
binding = "PRESENTATION_MAKER_BUCKET"
bucket_name = "presentation-videos"
preview_bucket_name = "presentation-videos-preview"
[[env.staging.kv_namespaces]]
binding = "PRESENTATION_MAKER_CACHE"
id = "2f2a03c8da9f471c867383b2dbb1ceca"
preview_id = "8293d34911c4414087b31fba4ac84929"
[[env.staging.durable_objects.bindings]]
name = "PRESENTATION_MAKER_JOB_MANAGER"
class_name = "JobManager"

# 本番環境
[env.production]
name = "presentaion-maker"
vars = { ENVIRONMENT = "production" }
[[env.production.routes]]
pattern = "presentation-maker.ohchans.com/api/*"
zone_name = "ohchans.com"
[[env.production.routes]]
pattern = "presentation-maker.ohchans.com/socket.io/*"
zone_name = "ohchans.com"
[[env.production.routes]]
pattern = "presentation-maker.ohchans.com/ws*"
zone_name = "ohchans.com"
[[env.production.r2_buckets]]
binding = "PRESENTATION_MAKER_BUCKET"
bucket_name = "presentation-videos"
[[env.production.kv_namespaces]]
binding = "PRESENTATION_MAKER_CACHE"
id = "2f2a03c8da9f471c867383b2dbb1ceca"
[[env.production.durable_objects.bindings]]
name = "PRESENTATION_MAKER_JOB_MANAGER"
class_name = "JobManager"

# リソース制限
[limits]
cpu_ms = 50
