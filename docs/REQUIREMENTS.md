# 要件定義 (REQUIREMENTS)

## 概要
プレゼンテーション動画を簡単に作成できるアプリケーション。
CLIモードとWebアプリモードの2つの実行方法を提供します。

## 機能要件

### 共通機能

#### 1. 入力処理
- Markdown ファイル (`.md`) と テキストファイル (`.txt`) を読み込む
- ファイル名の命名規則 `{番号}__{タイトル}.{拡張子}` に基づき、スライドと台本を紐付ける
- 番号順に処理を行う

**例:**
```
010__title.md       # スライド
010__title.txt      # 台本
020__introduction.md
020__introduction.txt
```

#### 2. 音声合成

**サーバー側 (本番環境推奨):**
- **VOICEVOX**: 高品質な日本語TTS、サーバー側で処理
  - `[pause:N]` 構文による無音挿入をサポート
  - 無音音声のキャッシング機能
  - 安定した動作と高品質な音声

**ブラウザ側 (実験的・開発中):**
- **Sherpa-onnx (WASM)**: 現在プレースホルダー実装
  - CORS/COEP制限により外部CDNからのロードが困難なため、一時的に無効化
  - 本格実装にはWASMファイルの自己ホスティングが必要
- **Transformers.js (onnxruntime-web)**: **実装済み (英語のみ)**
  - ブラウザ内で完結する音声合成
  - 初回実行時にモデルダウンロードが必要 (約100-200MB)
  - **キャッシュ機能**: 2回目以降はキャッシュを利用して高速ロード (Cache API + HTTP Cache)
  - 現在は英語モデル (`Xenova/speecht5_tts`) のみサポート

**技術的課題:**
- Web Speech APIはブラウザの制限により音声録音不可
- ブラウザのCOEP/CORSポリシーにより外部リソースの読み込みに制限
- 大容量モデルファイルのダウンロードとメモリ使用量

**推奨:** 本番環境ではVOICEVOX(サーバー側)の使用を強く推奨します。

#### 3. スライド画像生成
- Markdown の内容をスライド画像としてレンダリング
- Puppeteer を使用してHTML→PNG変換
- 1920x1080 解像度

#### 4. 動画生成
- 生成された音源の長さに合わせて、静止画から無音動画 (`.nosound.mp4`) を生成
- 音声ファイルと無音動画を結合し、各スライドの動画ファイル (`.mp4`) を生成

#### 5. 動画結合
- 生成された各スライドの動画を番号順に連結
- 1つのプレゼンテーション動画 (`final_presentation.mp4`) を生成

#### 6. 環境変数による設定
- VOICEVOX のベースURL設定
- スピーカーID設定 (音声の種類)

### CLIモード固有機能

#### 7. バッチ処理
- `input/` ディレクトリ内のファイルを一括処理
- `output/` ディレクトリに結果を保存
- コマンドライン実行: `pnpm start`

**出力ファイル:**
```
output/
├── 010__title.wav              # 音声
├── 010__title.png              # スライド画像
├── 010__title.nosound.mp4      # 無音動画
├── 010__title.mp4              # 完成動画
└── final_presentation.mp4      # 全体結合動画
```

### Webアプリモード固有機能

#### 8. ファイルアップロード
- ローカルフォルダからファイルを一括アップロード
- ブラウザのファイル選択UIを使用
- サーバー側でファイル解析・グループ化

#### 9. 手動入力
- ブラウザ上でスライドとスクリプトを直接入力
- 2列グリッドレイアウト (左: スライド、右: スクリプト)
- スライドの追加・削除機能
- **データ永続化**: 入力内容は `localStorage` に自動保存
- **クリア機能**: 全入力をリセットするボタンを提供

#### 10. 非同期ジョブ処理
- Bullキューによるジョブ管理
- 複数ジョブの並列処理
- ジョブステータスの追跡

#### 11. リアルタイム進捗表示
- Socket.IOによるリアルタイム通信
- 進捗パーセンテージ表示
- 現在処理中のスライド表示

#### 12. 動画プレビュー・ダウンロード
- ブラウザ上で動画プレビュー
- ダウンロードボタン
- 動画URLの提供

#### 13. ブラウザ側動画生成 (実験的)
- **FFmpeg.wasm**: ブラウザ内でFFmpegを実行
- サーバーを使わずにクライアント側で完結
- ブラウザ側TTS (Sherpa-onnx / Transformers.js) と組み合わせて使用
- 進捗表示とログ出力

#### 14. REST API
- `POST /api/upload-folder` - ファイルアップロード
- `POST /api/generate` - 手動入力からの生成
- `GET /api/jobs/:id` - ジョブステータス取得

#### 15. WebSocket通信
- `join:job` - ジョブルームへの参加
- `job:progress` - 進捗通知
- `job:completed` - 完了通知
- `job:failed` - エラー通知

## 非機能要件

### パフォーマンス
- 音声生成: 1スライドあたり5秒以内
- スライド画像生成: 1スライドあたり3秒以内
- 動画生成: 1スライドあたり10秒以内
- Webアプリ応答時間: 200ms以内 (API)

### スケーラビリティ
- 最大スライド数: 100枚まで対応
- 同時ジョブ数: 10ジョブまで (Webアプリ)
- ファイルサイズ制限: 10MB/ファイル

### 可用性
- VOICEVOX API障害時のエラーハンドリング
- Redis障害時のグレースフルデグラデーション (Webアプリ)
- ジョブ失敗時の自動リトライ

### セキュリティ
- ファイルアップロード検証 (拡張子、サイズ)
- XSS対策 (入力サニタイズ)
- 一時ファイルの自動削除

### 互換性
- **OS**: Windows (WSL2推奨)
- **Node.js**: v18以上
- **ブラウザ**: Chrome, Firefox, Edge (最新版)

### 保守性
- TypeScript による型安全性
- ユニットテストカバレッジ: 80%以上
- ドキュメント完備

### 技術要件
- **言語**: TypeScript
- **パッケージマネージャ**: pnpm
- **動画処理**: fluent-ffmpeg (サーバー), @ffmpeg/ffmpeg (ブラウザ)
- **音声合成**: 
  - VOICEVOX (サーバー側)
  - Sherpa-onnx WASM (ブラウザ側)
  - Transformers.js + onnxruntime-web (ブラウザ側)
- **Webフレームワーク**: Hono (バックエンド)
- **UIフレームワーク**: Vue.js 3 (フロントエンド)
- **ジョブキュー**: Bull + Redis
- **リアルタイム通信**: Socket.IO
- **スライドレンダリング**: html-to-image (ブラウザ側)

## 制約事項

### 技術的制約
- FFmpeg がシステムにインストールされている必要がある
- VOICEVOX が起動している必要がある
- Redis が起動している必要がある (Webアプリモード)

### ビジネス的制約
- 個人利用・商用利用可能
- VOICEVOX の利用規約に準拠
- オープンソースライセンス (ISC)

## 将来の拡張

### 短期 (v2.1)
- [x] ブラウザ側動画生成 (FFmpeg.wasm)
- [x] ブラウザ側TTS (Sherpa-onnx, Transformers.js)
- [ ] ユーザー認証機能
- [ ] プロジェクト保存機能
- [ ] スライドテンプレート

### 中期 (v3.0)
- [ ] クラウドストレージ連携 (Google Drive, Dropbox)
- [ ] リアルタイムコラボレーション
- [ ] 動画編集機能 (トリミング、エフェクト)

### 長期 (v4.0)
- [ ] AIによる自動スライド生成
- [ ] 多言語対応
- [ ] モバイルアプリ版
