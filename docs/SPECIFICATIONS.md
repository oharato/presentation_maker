# 仕様書 (SPECIFICATIONS)

## ファイル命名規則

### 入力ファイル (CLI / Webアプリ共通)
- **スライド**: `{番号}__{タイトル}.md`
- **台本**: `{番号}__{タイトル}.txt`

**規則:**
- `__` (アンダースコア2つ) で番号とタイトルを区切る
- 番号が一致するファイルをペアとして扱う
- タイトル部分は一致していなくても良い（番号を正とする）
- タイトルは空でも良い (例: `020__.md`)

**例:**
```
input/
├── 010__title.md
├── 010__title.txt
├── 020__introduction.md
├── 020__introduction.txt
└── 030__.md              # タイトルなし
```

### 出力ファイル (CLI)
- **音声**: `output/{番号}__{タイトル}.wav`
- **スライド画像**: `output/{番号}__{タイトル}.png`
- **無音動画**: `output/{番号}__{タイトル}.nosound.mp4`
- **結合動画**: `output/{番号}__{タイトル}.mp4`
- **最終成果物**: `output/final_presentation.mp4`

### 出力ファイル (Webアプリ)
- **動画**: `public/videos/{jobId}_{番号}.mp4`
- **最終成果物**: `public/videos/{jobId}_final.mp4`

## 処理フロー

### CLIモード

1. **ファイルスキャン**
   - `input/` ディレクトリをスキャン
   - 処理対象のファイルをリストアップ
   - 番号でグループ化

2. **各スライドの処理** (番号順)
   
   a. **音声生成**
   - `.txt` の内容を VOICEVOX API に送信
   - `[pause:N]` 構文を解析し、無音を挿入
   - `output/` に `.wav` として保存
   
   b. **スライド画像生成**
   - `.md` の内容を Marked でHTMLに変換
   - Puppeteer でスクリーンショット
   - `output/` に `.png` として保存
   
   c. **無音動画生成**
   - 生成された `.wav` の再生時間を取得
   - FFmpeg で画像をその時間分ループする動画を作成
   - `output/` に `.nosound.mp4` として保存
   
   d. **音声・動画結合**
   - `.wav` と `.nosound.mp4` を結合
   - `output/` に `.mp4` として保存
   - 生成された動画パスをリストに追加

3. **全動画結合**
   - リストに追加された動画を番号順に連結
   - `output/final_presentation.mp4` として保存

### Webアプリモード

1. **ファイルアップロード / 手動入力**
   - ブラウザからファイルアップロードまたは手動入力
   - サーバー側でファイル解析・グループ化
   - ジョブIDを生成

2. **ジョブキューに追加**
   - Bull Queue にジョブを追加
   - Redis にジョブデータを保存
   - クライアントに jobId を返却

3. **ワーカーによる処理**
   - Video Worker がジョブを取得
   - 各スライドを順次処理 (CLIモードと同様)
   - 進捗を Socket.IO で通知

4. **完了通知**
   - 最終動画を `public/videos/` に保存
   - Socket.IO で完了通知
   - 動画URLをクライアントに送信

## データフォーマット

### スライドデータ (内部)
```typescript
interface Slide {
  id: string;           // スライド番号
  markdown: string;     // Markdownコンテンツ
  script: string;       // トークスクリプト
}
```

### ジョブデータ (Webアプリ)
```typescript
interface VideoJobData {
  jobId: string;
  slides: Slide[];
}
```

### 進捗データ (Webアプリ)
```typescript
interface JobProgress {
  jobId: string;
  progress: number;     // 0-100
  message: string;      // "Processing slide 2/5"
}
```

## 音声合成仕様

### VOICEVOX API
- **ベースURL**: `http://127.0.0.1:50021` (デフォルト)
- **エンドポイント**:
  - `POST /audio_query` - 音声クエリ作成
  - `POST /synthesis` - 音声合成

### ポーズ構文
- **形式**: `[pause:N]`
- **N**: 秒数 (小数点可)
- **例**: `こんにちは。[pause:1.5]今日は...`

### 無音音声キャッシング
- 同じ長さの無音音声は再利用
- 一時ディレクトリにキャッシュ
- ファイル名: `silence_{秒数}s_{タイムスタンプ}.wav`

## スライドレンダリング仕様

### HTML生成
- Marked でMarkdownをHTMLに変換
- カスタムCSSでスタイリング
- 1920x1080 解像度

### スタイル
```css
body {
  width: 1920px;
  height: 1080px;
  font-family: 'Segoe UI', sans-serif;
  background-color: #f0f0f0;
  font-size: 48px;
}
h1 { font-size: 120px; }
h2 { font-size: 80px; }
```

## 動画生成仕様

### 無音動画
- **コーデック**: libx264
- **解像度**: 1920x1080
- **フレームレート**: 30fps
- **入力**: 静止画像 (PNG)
- **時間**: 音声ファイルの長さに合わせる

### 音声・動画結合
- **音声コーデック**: AAC
- **動画コーデック**: libx264 (copy)
- **同期**: 音声の長さに合わせる

### 動画連結
- **方法**: FFmpeg concat demuxer
- **フォーマット**: MP4
- **順序**: スライド番号順

## エラーハンドリング

### CLIモード
- **対応する台本がないスライド**: 
  - 動画生成をスキップ
  - ログに警告を出力
  
- **対応するスライドがない台本**: 
  - 音声のみ生成
  - 動画結合はスキップ
  
- **結合する動画がない場合**: 
  - 最終動画生成をスキップ
  - ログに警告を出力

### Webアプリモード
- **ファイルアップロードエラー**:
  - 400 Bad Request を返却
  - エラーメッセージを表示
  
- **ジョブ処理エラー**:
  - Socket.IO で `job:failed` イベント送信
  - エラー詳細をログに記録
  
- **VOICEVOX接続エラー**:
  - リトライ (最大3回)
  - 失敗時はジョブを失敗扱い

## パフォーマンス最適化

### 並列処理
- Webアプリモード: 複数ワーカーで並列処理可能
- CLIモード: 順次処理 (シンプルさ優先)

### キャッシング
- 無音音声のキャッシング
- 将来: スライド画像のキャッシング

### ファイルクリーンアップ
- 一時ファイルの自動削除
- アップロードファイルの削除
- 古い動画ファイルの定期削除 (将来実装)

## セキュリティ

### 入力検証
- ファイルサイズ制限: 10MB/ファイル
- 許可する拡張子: `.md`, `.txt`
- スライド数制限: 100枚まで

### サニタイズ
- Markdown入力のサニタイズ (XSS対策)
- ファイル名のサニタイズ

### アクセス制御
- 将来実装: ユーザー認証
- 将来実装: ジョブ所有権チェック

## 互換性

### ブラウザ (Webアプリ)
- Chrome 90+
- Firefox 88+
- Edge 90+
- Safari 14+ (未検証)

### OS
- Windows 10/11
- WSL2 (推奨)

### Node.js
- v18.0.0 以上
- v20.0.0 推奨

## 制限事項

### 技術的制限
- 最大スライド数: 100枚
- 最大動画長: 60分
- 同時ジョブ数: 10 (Webアプリ)

### 既知の問題
- fluent-ffmpeg パッケージが deprecated
  - 代替パッケージなし、継続使用
- 大きな動画ファイルのメモリ使用量
  - 将来: ストリーミング処理に移行
